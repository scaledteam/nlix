#
# This E2 made by scaled
#

@name exit

switch (ThisAppState) {
    case 0,
        if (findAppByName("hotplugd") != NULL & varString("args") != "--force") {
            terminalPrintFast("You can lost hotplug function after exit. Use --force if you really want it.\n")
            appClose()
        }
        else {
            appNextState()
        }
        break
    
    case 1,
        local ThisWorkspaceApps = table()
        for (I = 1, Apps:count()) {
            local App = Apps[I, table]
            if (App["workspace", table] == ThisWorkspace) {
                ThisWorkspaceApps:pushTable(App)
            }
        }
        varWrite("apps", ThisWorkspaceApps)
        appNextState()
        break
    
    case 2,
        varWrite("exitAllTime", systime() + 2)
        local ThisWorkspaceApps = varTable("apps")
        for (I = 1, ThisWorkspaceApps:count()) {
            ThisWorkspaceApps[I, table]:sendEvent("exit")
        }
        appNextState()
        break
    
    case 3,
        if (systime() >= varNumber("exitAllTime")) {
            local ThisWorkspaceApps = varTable("apps")
            for (I = 1, ThisWorkspaceApps:count()) {
                local App = ThisWorkspaceApps[I, table]
                if (App:isValid()) {
                    App:appClose()
                }
            }
            ThisWorkspace:clear()
        }
        break
}
