#
# Created by scaled
#

@name nlix

@persist KERNEL_PERF KERNEL_OVERLOAD 
@persist KernelState0 KernelState1
@persist Programs:table

if (first()) {
    #include "nlix/init/first"
}

if (tickClk()) {
    switch (KernelState0) {
        case 0,
            while (perf(KERNEL_PERF)) {
                KernelState1++
                switch (KernelState1) {
                    # Kernel libs
                    case 1, #include "nlix/libraries/kernel/lib-object" break
                    case 2, #include "nlix/libraries/kernel/lib-program" break
                    
                    # Important libs
                    case 3, #include "nlix/libraries/lib-vars" break
                    case 4, #include "nlix/libraries/lib-event" break
                    case 5, #include "nlix/libraries/lib-file" break
                    case 6, #include "nlix/libraries/lib-state" break
                    
                    # Driver libs
                    case  7, #include "nlix/libraries/drivers/lib-driver"            break
                    case  8, #include "nlix/libraries/drivers/lib-driver-terminal"  break
                    case  9, #include "nlix/libraries/drivers/lib-driver-keyboard"  break
                    case 10, #include "nlix/libraries/drivers/lib-driver-egp"       break
                    case 11, #include "nlix/libraries/drivers/lib-driver-cursor"    break
                    case 12, #include "nlix/libraries/drivers/lib-driver-digi"      break
                    case 13, #include "nlix/libraries/drivers/lib-driver-gl"        break
                    
                    # Other libs
                    case 14, #include "nlix/libraries/lib-simple-keyboard" break
                    
                    # Init
                    case 15, #include "nlix/init/settings" break
                    case 16, #include "nlix/init/fonts" break
                    case 17, #include "nlix/init/gtable" break
                    case 18, #include "nlix/init/autostart" break
                    
                    # Move to execution state
                    case 19, KernelState0++, KernelState1 = 0
                }
                if (KernelState0 != 0) {
                    break
                }
            }
            break
        
        case 1,
            while (perf(KERNEL_PERF)) {
                KernelState1++
                if (KernelState1 > Programs:count()) {
                    KernelState1 = 1
                }
                
                #include "nlix/context/program"
                #include "nlix/context/vars"
                #include "nlix/context/events"
                
                switch (ThisProgramName) {
                    # System daemons
                    case "hotplugd",            #include "nlix/programs/hotplugd"                   break
                    
                    # Drivers.
                    case "driver-terminal",     #include "nlix/programs/drivers/driver-terminal"    break
                    case "driver-keyboard",     #include "nlix/programs/drivers/driver-keyboard"    break
                    case "driver-egp",          #include "nlix/programs/drivers/driver-egp"       break
                    case "driver-cursor",       #include "nlix/programs/drivers/driver-cursor"      break
                    case "driver-digi",         #include "nlix/programs/drivers/driver-digi"        break
                    case "driver-gl",           #include "nlix/programs/drivers/driver-gl"          break
                    
                    # Simplifier tools.
                    case "simple-keyboard",     #include "nlix/programs/simple-keyboard"            break
                    
                    # Shells.
                    case "sh",                  #include "nlix/programs/sh"                         break
                    case "rund",                #include "nlix/programs/rund"                       break
                    
                    # Quit tools.
                    case "halt",                #include "nlix/programs/halt"                       break
                    case "reboot",              #include "nlix/programs/reboot"                     break
                    case "exit",                #include "nlix/programs/exit"                       break
                    case "login",               #include "nlix/programs/login"                      break
                    
                    # Classic console utilites.
                    case "clear",               #include "nlix/programs/clear"                      break
                    case "echo",                #include "nlix/programs/echo"                       break
                    case "test",                #include "nlix/programs/test"                       break
                    
                    # Math
                    case "bc",                  #include "nlix/programs/bc"                         break
                    
                    # Server utils
                    case "server-uptime",       #include "nlix/programs/server-uptime"              break
                    case "server-players",      #include "nlix/programs/server-players"             break
                    case "server-hostname",     #include "nlix/programs/server-hostname"            break
                    
                    # Apps control.
                    case "pkill",               #include "nlix/programs/pkill"                      break
                    case "kill",                #include "nlix/programs/kill"                       break
                    case "plist",               #include "nlix/programs/plist"                      break
                    
                    # Performande control and tests.
                    case "perf",                #include "nlix/programs/perf"                       break
                    case "ops",                 #include "nlix/programs/ops"                        break
                    case "print-pi",            #include "nlix/programs/print-pi"                   break
                    case "uptime",              #include "nlix/programs/uptime"                     break
                    
                    # Egp tests.
                    case "egp-clocks",          #include "nlix/programs/egp-clocks"                 break
                    case "egp-eyes",            #include "nlix/programs/egp-eyes"                   break
                    
                    # Window manager
                    case "egp-wm",              #include "nlix/programs/egp-wm"                     break
                    case "egp-wm-shell",        #include "nlix/programs/egp-wm-shell"               break
                    
                    # Workspace management
                    #case "workspaces-manager",  #include "nlix/programs/workspaces-manager"         break
                    
                    # Digital screen
                    case "digi-scanner",        #include "nlix/programs/digi-scanner"               break
                    
                    # Egp 3d
                    case "wustdd",              #include "nlix/programs/wustdd"                     break
                    
                    # Files
                    case "ls",                  #include "nlix/programs/ls"                         break
                    case "cat",                 #include "nlix/programs/cat"                        break
                    
                    default,
                        ThisProgram:programKill()
                }
            }
            break
        
        default,
            KernelState0 = 0
            KernelState1 = 0
    }
}
