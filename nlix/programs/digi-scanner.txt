#
# Created by scaled
#

@name digi-scanner

switch (P["state", number]) {
    case 0,
        if (digiInit()) {
            P["PIXELS_COUNT", number] = digiResolution()[1] * digiResolution()[2]
            P["color", vector] = vec(255)
            
            P["state", number] = 1
        }
        break
    
    case 1,
        #if (digiIsIdle()) {
            local Color = P["color", vector]
            local Counter = P["counter", number]
            local DIGI_RESOLUTION = digiResolution()
            local DIGI_OFFSET = shift(DIGI_RESOLUTION) / 2
            local RANGER_DISTANCE = 2000
            
            for (I = 1, KERNEL_OVERLOAD) {
                local X = Counter % DIGI_RESOLUTION[1]
                local Y = int(Counter / DIGI_RESOLUTION[1])
                
                local Direction = digiEntity():toWorldAxis(vec(vec2(Y, X) - DIGI_OFFSET, -DIGI_RESOLUTION[2]))
                local RangerMain = rangerOffset(RANGER_DISTANCE, digiEntity():toWorld(vec(0, 0, -10)), Direction)
                local Brightness = 0
                if (RangerMain:hit()) {
                    Brightness = min(1, 1 - RangerMain:distance() / RANGER_DISTANCE)
                }
                
                digiDrawPixel(vec2(X, Y), Color * Brightness)
                
                if (Counter >= P["PIXELS_COUNT", number]) {
                    programKill()
                    break
                }
                else {
                    Counter++
                }
            }
            P["counter", number] = Counter
        #}
        break
}
