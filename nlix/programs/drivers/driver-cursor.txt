#
# This E2 made by scaled
#

@name driver-cursor

switch (stateGet()) {
    case 0,
        eventInit()
        driverInit()
        stateNext()
        break
    
    case 1,
        local Device = NULL
        if (egpInit()) {
            Device = varTable("driver-egp"):driverGetDevice()
            
            if (Device:type() == "gmod_wire_egp") {
                varWrite("device", Device)
                
                if (Device:type() == "gmod_wire_egp") {
                    varWrite("need-to-find-user", 1)
                    stateNext()
                }
            }
            else {
                Device = NULL
            }
        }
        
        if (Device == NULL) {
            if (driverPopDevice("virtual-cursor")) {
                stateNext()
            }
        }
        break
    
    case 2,
        #ifdef findInSphere(vector,number)
            if (varNumber("need-to-find-user")) {
                findIncludeClass("player")
            }
        #endif
        
        if (varNumber("need-to-find-user")) {
            stateNext()
        }
        else {
            stateSet(4)
        }
        break
    
    case 3,
        if (varNumber("need-to-find-user")) {
            #ifdef findInSphere(vector,number)
                local ScanPos = varTable("device")["port", wirelink]:entity():pos()
                findInSphere(ScanPos, 100)
                findSortByDistance(ScanPos)
                varWrite("user", find())
            #else
                local ScanPos = varTable("device")["port", wirelink]:entity():pos()
                local Player_Distance = 100
                foreach(I, Player:entity = players()){
                    local Distance = ScanPos:distance(Player:pos())
                    if (Distance < Player_Distance){
                        Player_Distance = Distance
                        varWrite("user", Player)
                    }
                }
            #endif
        }
        
        stateNext()
        break
    
    case 4,
        local Device = varTable("device")
        
        switch (Device:type()) {
            case "gmod_wire_egp",
                varWrite("pos", Device["port", wirelink]:egpCursor(varEntity("user")))
                varWrite("use", varEntity("user"):keyUse())
                break
            
            case "virtual-cursor",
                varWrite("pos", Device["pos", vector2])
                varWrite("use", Device["use", number])
                break
        }
        if (varNumber("need-to-find-user")) {
            stateSet(3)
        }
        
        if (eventWaitString("exit")) {
            driverPushDevice()
            programKill()
        }
        break
}
