#
# This E2 made by scaled
#

@name exit

switch (P["state", number]) {
    case 0,
        if (programFindByName("hotplugd") != NULL & P["args", array][1, string] != "--force") {
            if (terminalInit()) {
                terminalPrint("You can lost hotplug function after exit. Use --force if you really want it.\n")
            }
            programKill()
        }
        else {
            P["state", number] = 1
        }
        break
    
    case 1,
        local Programs = table()
        for (I = 1, Programs:count()) {
            local Program = Programs[I, table]
            if (Program["environment", table] == E) {
                Programs:pushTable(Program)
            }
        }
        P["programs", table] = Programs
        P["state", number] = 2
        break
    
    case 2,
        P["exitAllTime", number] = systime() + 2
        local Programs = P["programs", table]
        for (I = 1, Programs:count()) {
            Programs[I, table]:eventSend("exit")
        }
        P["state", number] = 3
        break
    
    case 3,
        if (systime() >= P["exitAllTime", number]) {
            local Programs = P["programs", table]
            for (I = 1, Programs:count()) {
                local Program = Programs[I, table]
                if (Program:isValid()) {
                    Program:programKill()
                }
            }
            E:clear()
        }
        break
}
