#
# This E2 made by scaled
#

@name exit

switch (stateGet()) {
    case 0,
        if (programFindByName("hotplugd") != NULL & varArray("args")[1, string] != "--force") {
            if (terminalInit()) {
                terminalPrint("You can lost hotplug function after exit. Use --force if you really want it.\n")
            }
            programKill()
        }
        else {
            stateNext()
        }
        break
    
    case 1,
        local ThisEnvironmentPrograms = table()
        for (I = 1, Programs:count()) {
            local Program = Programs[I, table]
            if (Program["environment", table] == ThisEnvironment) {
                ThisEnvironmentPrograms:pushTable(Program)
            }
        }
        varWrite("apps", ThisEnvironmentPrograms)
        stateNext()
        break
    
    case 2,
        varWrite("exitAllTime", systime() + 2)
        local ThisEnvironmentPrograms = varTable("apps")
        for (I = 1, ThisEnvironmentPrograms:count()) {
            ThisEnvironmentPrograms[I, table]:eventSend("exit")
        }
        stateNext()
        break
    
    case 3,
        if (systime() >= varNumber("exitAllTime")) {
            local ThisEnvironmentPrograms = varTable("apps")
            for (I = 1, ThisEnvironmentPrograms:count()) {
                local Program = ThisEnvironmentPrograms[I, table]
                if (Program:isValid()) {
                    Program:programKill()
                }
            }
            ThisEnvironment:clear()
        }
        break
}
