#
# Created by scaled
#

@name hotplugd

switch (stateGet()) {
    # Hot plug
    case 0,
        local Counter = varNumber("counter") + 1
        
        local Port = select(Counter,
            Port1,
            Port2,
            Port3,
            Port4
        )
        
        if ((Port != varWirelink("PortOld" + Counter)) & Port) {
            # Check if device exists
            local DeviceExists = 0
            local DeviceType = Port:entity():type()
            for (I = 1, ThisProgram["workspace", table]:count()) {
                if (ThisProgram["workspace", table][I, table]["port", wirelink]:entity():type() == DeviceType & ThisProgram["workspace", table][I, table]["port", wirelink] == Port) {
                    DeviceExists = 1
                    break
                }
            }
            
            if (!DeviceExists) {
                local Device = object(DeviceType)
                Device["port", wirelink] = Port
                
                ThisProgram["workspace", table]:pushTable(Device)
            }
        }
        varWrite("PortOld" + Counter, Port)
        
        if (Counter >= PORTS_COUNT) {
            stateNext()
            varWrite("counter", 0)
        }
        else {
            varWrite("counter", Counter)
        }
        break
    
    # Hot unplug
    case 1,
        local Counter = varNumber("counter") + 1
        
        local Device = ThisProgram["workspace", table]["devices", table][Counter, table]
        if (!Device["type", string]:find("virtual") & !Device["port", wirelink]:entity():isValid()) {
            Device:clear()
            ThisProgram["workspace", table]["devices", table]:remove(Counter)
            Counter--
        }
        
        if (Counter >= ThisProgram["workspace", table]["devices", table]:count()) {
            statePrev()
            varWrite("counter", 0)
        }
        else {
            varWrite("counter", Counter)
        }
        break
}
